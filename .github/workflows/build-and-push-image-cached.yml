name: build-and-push-image-cached

on:
  workflow_call:
    inputs:
      runner_name:
        description: "The name of the runner to run the workflow on"
        type: string
        default: ubuntu-latest-m
        required: false
      image_name:
        description: "The name of the image to build"
        type: string
        default: ${{ github.repository }}
        required: false
      context:
        description: "The context to build the image from"
        type: string
        default: .
        required: false
      dockerfile:
        description: "The dockerfile to build"
        type: string
        default: Dockerfile
        required: false
      build_args:
        description: "Docker build arguments"
        required: false
        type: string
      cache_tag:
        description: "Tag suffix for the cache image in registry"
        type: string
        default: buildcache
        required: false
    secrets:
      FEISHU_CUSTOMERBOT_WEBHOOK:
        required: true
      FEISHU_CUSTOMERBOT_SECRET:
        required: true
      GH_RELEASE_TOKEN:
        required: true
    outputs:
      image_tag:
        description: "The image tag"
        value: ${{ jobs.build-and-push-app-image.outputs.image_tag }}
      image_digest:
        description: "The image digest"
        value: ${{ jobs.build-and-push-app-image.outputs.image_digest }}

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push-app-image:
    runs-on: ${{ inputs.runner_name }}
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
      image_digest: ${{ steps.build-and-push.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: echo "image_tag=${{ env.REGISTRY }}/${{ inputs.image_name }}:${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Manifest File
        run: |
          echo "GIT_COMMIT_HASH=$(git rev-parse HEAD)" > manifest.metadata
          echo "GIT_BRANCH_NAME=$(git branch --show-current)" >> manifest.metadata
          echo "GIT_TAGS=$(git tag --contains)" >> manifest.metadata
          echo "IMAGE_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> manifest.metadata
          cat manifest.metadata

      - name: Build and push Docker image with registry cache
        id: build-and-push
        uses: docker/build-push-action@v6.16.0
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: true
          tags: ${{ steps.set-tag.outputs.image_tag }}
          build-args: |
            ${{ inputs.build_args }}
            GITHUB_TOKEN=${{ secrets.GH_RELEASE_TOKEN }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.cache_tag }}
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.cache_tag }},mode=max

      - name: Notify Lark Bot
        id: notify-lark-bot
        uses: SerendipityOneInc/feishu-actions@main
        with:
          FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
          FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
        env:
          FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
          FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
          MSGTYPE: interactive
          CONTENT: |
            ** âœ… Build [${{ github.event.repository.name }}](${{ github.event.head_commit.url }}) success! **
            - Build ${{ inputs.image_name }} with registry cache successful!
            - ${{ github.event.head_commit.message }}
            ** [${{ github.ref_name}}](${{ steps.set-tag.outputs.image_tag }}) by ${{ github.actor }} **
            ** DIGEST **
            - ${{ steps.build-and-push.outputs.digest }}
