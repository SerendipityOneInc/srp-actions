name: python-code-quality-v2

on:
    workflow_call:
        inputs:
            python_version:
                description: 'Python version'
                type: string
                required: true
                default: '3.10'
            repo_name:
                description: 'Repository name'
                type: string
                required: true
            runner_name:
              description: "The name of the runner to run the workflow on"
              type: string
              default: ubuntu-latest
              required: false
            ruff_config_file:
              description: "Path to ruff configuration file (pyproject.toml or ruff.toml)"
              type: string
              default: ''
              required: false
            pyright_config_file:
              description: "Path to pyright configuration file (pyrightconfig.json or pyproject.toml)"
              type: string
              default: ''
              required: false
            enable_coverage:
              description: "Enable test coverage reporting and enforcement"
              type: boolean
              default: false
              required: false
            coverage_threshold:
              description: "Minimum coverage percentage required (only used if enable_coverage is true)"
              type: string
              default: '80'
              required: false
            coverage_source:
              description: "Source directory to measure coverage for"
              type: string
              default: 'app'
              required: false
            enable_mongodb:
              description: "Enable MongoDB service container for integration tests"
              type: boolean
              default: false
              required: false
            mongodb_version:
              description: "MongoDB Docker image version (only used if enable_mongodb is true)"
              type: string
              default: '7.0'
              required: false
        secrets:
            FEISHU_CUSTOMERBOT_WEBHOOK:
                required: true
            FEISHU_CUSTOMERBOT_SECRET:
                required: true
            GH_RELEASE_TOKEN:
              required: true
jobs:
    build-and-test:
        runs-on: ${{ inputs.runner_name }}
        services:
          mongodb:
            image: ${{ inputs.enable_mongodb && format('mongo:{0}', inputs.mongodb_version) || '' }}
            ports:
              - 27017:27017
            env:
              MONGO_INITDB_ROOT_USERNAME: mongo
              MONGO_INITDB_ROOT_PASSWORD: mongo
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: ${{ inputs.python_version }}
                cache: 'pip'

            - name: Install dependencies
              id: install-deps
              env:
                GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
              run: |
                git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
                pip install -r requirements.txt
                [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt
                pip install ruff pyright

            - name: Check code formatting with ruff
              id: ruff-format
              run: |
                if [ -n "${{ inputs.ruff_config_file }}" ]; then
                  ruff format --check --config ${{ inputs.ruff_config_file }} .
                else
                  ruff format --check .
                fi

            - name: Check code with ruff (linting and import sorting)
              id: ruff-lint
              if: success() || failure()
              run: |
                if [ -n "${{ inputs.ruff_config_file }}" ]; then
                  ruff check --config ${{ inputs.ruff_config_file }} .
                else
                  ruff check .
                fi

            - name: Type check with pyright
              id: pyright-check
              if: success() || failure()
              run: |
                if [ -n "${{ inputs.pyright_config_file }}" ]; then
                  pyright --project ${{ inputs.pyright_config_file }}
                else
                  pyright
                fi

            - name: Run unit tests
              id: run-unit-tests
              if: success() || failure()
              env:
                TEST_MONGODB_HOST: ${{ inputs.enable_mongodb && 'localhost' || '' }}
              run: |
                export PYTHONPATH=$PYTHONPATH:$(pwd)
                [ -f .env.example ] && cp .env.example .env
                [ -f ${{ inputs.repo_name }}-dev.env.example ] && cp ${{ inputs.repo_name }}-dev.env.example ${{ inputs.repo_name }}-dev.env
                if [ "${{ inputs.enable_coverage }}" == "true" ]; then
                  pytest tests --cov=${{ inputs.coverage_source }} --cov-report=term-missing --cov-fail-under=${{ inputs.coverage_threshold }}
                else
                  pytest tests
                fi

            - name: Upload logs as an artifact
              if: failure() && steps.run-unit-tests.outcome == 'failure'
              uses: actions/upload-artifact@v4
              with:
                name: uvicorn-logs
                path: uvicorn.log

            - name: Generate job summary
              if: always()
              run: |
                echo "## Code Quality Check Results" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
                echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

                # Formatting check
                if [ "${{ steps.ruff-format.outcome }}" == "success" ]; then
                  echo "| Formatting (ruff format) | ✅ PASS |" >> $GITHUB_STEP_SUMMARY
                elif [ "${{ steps.ruff-format.outcome }}" == "failure" ]; then
                  echo "| Formatting (ruff format) | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Formatting (ruff format) | ⏭️ SKIPPED |" >> $GITHUB_STEP_SUMMARY
                fi

                # Linting check
                if [ "${{ steps.ruff-lint.outcome }}" == "success" ]; then
                  echo "| Linting (ruff check) | ✅ PASS |" >> $GITHUB_STEP_SUMMARY
                elif [ "${{ steps.ruff-lint.outcome }}" == "failure" ]; then
                  echo "| Linting (ruff check) | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Linting (ruff check) | ⏭️ SKIPPED |" >> $GITHUB_STEP_SUMMARY
                fi

                # Type check
                if [ "${{ steps.pyright-check.outcome }}" == "success" ]; then
                  echo "| Type Check (pyright) | ✅ PASS |" >> $GITHUB_STEP_SUMMARY
                elif [ "${{ steps.pyright-check.outcome }}" == "failure" ]; then
                  echo "| Type Check (pyright) | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Type Check (pyright) | ⏭️ SKIPPED |" >> $GITHUB_STEP_SUMMARY
                fi

                # Unit tests
                if [ "${{ steps.run-unit-tests.outcome }}" == "success" ]; then
                  echo "| Unit Tests (pytest) | ✅ PASS |" >> $GITHUB_STEP_SUMMARY
                elif [ "${{ steps.run-unit-tests.outcome }}" == "failure" ]; then
                  echo "| Unit Tests (pytest) | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Unit Tests (pytest) | ⏭️ SKIPPED |" >> $GITHUB_STEP_SUMMARY
                fi

                echo "" >> $GITHUB_STEP_SUMMARY

                # Coverage info
                if [ "${{ inputs.enable_coverage }}" == "true" ]; then
                  echo "**Coverage threshold:** ${{ inputs.coverage_threshold }}% (source: \`${{ inputs.coverage_source }}\`)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi

                # MongoDB info
                if [ "${{ inputs.enable_mongodb }}" == "true" ]; then
                  echo "**MongoDB:** enabled (mongo:${{ inputs.mongodb_version }})" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi

                # Overall verdict
                if [ "${{ steps.ruff-format.outcome }}" == "success" ] && \
                   [ "${{ steps.ruff-lint.outcome }}" == "success" ] && \
                   [ "${{ steps.pyright-check.outcome }}" == "success" ] && \
                   [ "${{ steps.run-unit-tests.outcome }}" == "success" ]; then
                  echo "### ✅ Overall: PASS" >> $GITHUB_STEP_SUMMARY
                else
                  echo "### ❌ Overall: FAIL" >> $GITHUB_STEP_SUMMARY
                fi

            - name: Notify Lark Bot
              id: notify-lark-bot
              if: failure()
              uses: SerendipityOneInc/feishu-actions@main
              with:
                FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
                FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
              env:
                FEISHU_CUSTOMERBOT_WEBHOOK: ${{ secrets.FEISHU_CUSTOMERBOT_WEBHOOK }}
                FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_CUSTOMERBOT_SECRET }}
                MSGTYPE: interactive
                CONTENT: |
                    ** ❌ [${{ github.event.repository.name }}](${{ github.event.repository.url }}) Code Quality Check Failed **
                    ---
                    **Results:**
                    - Formatting (ruff): ${{ steps.ruff-format.outcome == 'success' && '✅ PASS' || steps.ruff-format.outcome == 'failure' && '❌ FAIL' || '⏭️ SKIP' }}
                    - Linting (ruff): ${{ steps.ruff-lint.outcome == 'success' && '✅ PASS' || steps.ruff-lint.outcome == 'failure' && '❌ FAIL' || '⏭️ SKIP' }}
                    - Type Check (pyright): ${{ steps.pyright-check.outcome == 'success' && '✅ PASS' || steps.pyright-check.outcome == 'failure' && '❌ FAIL' || '⏭️ SKIP' }}
                    - Unit Tests (pytest): ${{ steps.run-unit-tests.outcome == 'success' && '✅ PASS' || steps.run-unit-tests.outcome == 'failure' && '❌ FAIL' || '⏭️ SKIP' }}
                    ---
                    - Pull Request: [${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})
                    - Actor: ${{ github.actor }}
                    - Commit: [${{ github.sha }}](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
